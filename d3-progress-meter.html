<link rel="import" href="../polymer/polymer.html">

<script src="../d3/d3.min.js"></script>

<dom-module id="d3-progress-meter">

	<template>
		<style>
			:host {
				display: inline-block;
			}
			#background {
				/* var(--paper-grey-300) */
				fill: #e0e0e0;
			}
			#progress {
				/* var(--paper-green-500) */
				fill: #4caf50;
			}
			#text {
				font-family: Arial, sans-serif;
			}
		</style>
		
		<svg width$=[[diameter]] height$=[[diameter]]>
			<g transform$=[[transform]]>
				<g>
					<path id="background"></path>
					<path id="progress"></path>
					<text id="text" dy=".35em" text-anchor="middle"></text>
				</g>
			</g>
		</svg>
	</template>

</dom-module>
	
<script>
(function() {

	var formatPercent = d3.format('.0%');

	Polymer({
		is: 'd3-progress-meter',
		properties: {
			progress: {
				type: Number,
				value: 0
			},
			radius: {
				type: Number,
				value: 100,
				observer: '_radiusChanged'
			},
			value: {
				type: Number,
				observer: '_valueChanged'
			},
			diameter: {
				type: Number,
				computed: '_computeDiameter(radius)'
			},
			transform: {
				type: String,
				computed: '_computeTransform(radius)'
			}
		},
		
		_computeDiameter: function(radius) {
			return 2 * radius;
		},
		_computeTransform: function(radius) {
			return "translate(" + radius + ", " + radius + ")";
		},
		_radiusChanged: function(oldVal, newVal) {
			this._onRadiusChanged();
			this._onValueChanged();
		},
		_valueChanged: function(oldVal, newVal) {
			this._onValueChanged();
		},
		_onRadiusChanged: function() {
			this.arc = d3.svg.arc()
						.startAngle(0)
						.innerRadius(9/10 * this.radius)
						.outerRadius(this.radius);
	
			this.$.text.style.fontSize = this.radius/2 + 'px';
			this.$.background.setAttribute('d', this.arc.endAngle(2 * Math.PI)());
		},
		_onValueChanged: function() {
			if (typeof this.value == 'undefined') {
				return;
			}
			this.value = Math.min(1, Math.max(0, this.value));
			
			var host = this;
			var i = d3.interpolate(this.progress, this.value);
			d3.transition().tween('progress', function() {
				return function(t) {
					host.progress = i(t);
					host.$.progress.setAttribute('d', host.arc.endAngle(2 * Math.PI * host.progress)());
					host.$.text.textContent = formatPercent(host.progress);
				};
			});
		}
	});

})();
</script>
