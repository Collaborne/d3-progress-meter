<!doctype html>
<link rel='import' href='bower_components/polymer/polymer-element.html'>
<script src='https://d3js.org/d3.v4.min.js'></script>

<!--
A chart that shows tasks as draggable dots

@demo demo/index.html
-->
<dom-module id='d3-task-planner'>
	<template>
		<style>
			:host {
				display: inline-block;
			}

			path {
				stroke-width: 2;
				fill: none;
			}

			.axis path,
			.axis line {
				fill: none;
				stroke: grey;
				stroke-width: 1;
				shape-rendering: crispEdges;
			}

			div.tooltip {
				position: absolute;
				text-align: center;
			}
		</style>
	</template>

	<script>
		/**
		 * @customElement
		 * @polymer
		 */
		class D3TaskPlanner extends Polymer.Element {

			static get is() {
				return 'd3-task-planner';
			}

			constructor() {
				super();
			}

			static get properties() {
				return {
					_schedule: {
						type: Object,
						value: {
							'deadlines': {
								'http://collaborne.com/schema/1.0/tasks/sensing': '2018-01-16',
								'http://collaborne.com/schema/1.0/tasks/visioning': '2018-01-24',
								'http://collaborne.com/schema/1.0/tasks/prototyping': '2018-01-31',
								'http://collaborne.com/schema/1.0/tasks/scaling': '2018-02-08'
							},
							'end': '2018-02-08',
							'nrNormDays': 14,
							'nrRealDays': 28,
							'start': '2018-01-01',
							'timeAllocation': 0.5
						}
					},
				};
			}

			buildInputData() {
				const projectTotalDuration = new Date(this._schedule.end).getTime() - new Date(this._schedule.start).getTime();
				return Object.keys(this._schedule.deadlines).map(idPhase => {
					const phaseDeadline = this._schedule.deadlines[idPhase];
					return {
						name: idPhase,
						date: phaseDeadline,
						progress: (new Date(phaseDeadline).getTime() - new Date(this._schedule.start).getTime()) / projectTotalDuration
					};
				});
			}

			ready() {
				super.ready();
				const margin = {
					top: 30,
					right: 20,
					bottom: 30,
					left: 50
				},
				width = 600 - margin.left - margin.right,
				height = 270 - margin.top - margin.bottom;

				// Define data to build the graphics
				let inputData = this.buildInputData();

				const recalculateSchedule = (taskId, newDeadline) => {
					const format = d3.timeFormat('%Y-%m-%d');
					this._schedule.deadlines[taskId] = format(new Date(newDeadline));
					return this.buildInputData();
				};

				// Set the ranges
				const x = d3.scaleTime()
					.domain([new Date(this._schedule.start), new Date(this._schedule.end)])
					.range([0, width]);

				const y = d3.scaleLinear()
					.domain([0, 100])
					.range([height, 0]);

				// Define the axes
				const xAxis = d3.axisBottom(x)
					.tickFormat(d3.timeFormat('%b'));

				const yAxis = d3.axisLeft(y);

				const div = d3.select('body').append('div')
					.attr('class', 'tooltip')
					.style('opacity', 0);

				// Adds the svg canvas
				const svg = d3.select('body')
					.append('svg')
					.attr('width', width + margin.left + margin.right)
					.attr('height', height + margin.top + margin.bottom)
					.append('g')
					.attr('transform',
						'translate(' + margin.left + ',' + margin.top + ')');

				// Parse the date / time
				const parseDate = d3.timeParse('%Y-%m-%d');

				inputData.forEach(d => {
					d.date = parseDate(d.date);
					d.close = +(d.progress * 100);
				});

				// Add vertical line on today's date
				//const today = new Date();
				// Debug
				const today = new Date('2018-01-25T23:00:00.000Z');
				svg.append('line')
					.attr('x1', x(today))
					.attr('y1', 0)
					.attr('x2', x(today))
					.attr('y2', height)
					.style('stroke-width', 2)
					.style('stroke', 'red');

				// Function to call when dots are dragged
				function dragged(d) {
					// Allow post-poning deadlines only after today
					if (d.date >= today && d.date > today) {
						d.date = x.invert(d3.event.x);
						// Move the dots
						d3.select(this)
							.attr('cx', x(d.date));

						// Redraw line connecting dots
						svg.select('path').attr('d', valueline(inputData));
					}
				}

				// Define the line connecting the dots
				const valueline = d3.line().x(d => x(d.date)).y(d => y(d.close));

				// Add the valueline path
				svg.append('path')
					.attr('class', 'line')
					.style('stroke', 'black')
					.attr('fill', 'none')
					.attr('d', valueline(inputData));

				const dragbehaviour = d3.drag().on('drag', dragged);

				const buildTooltipText = d => {
					const format = d3.timeFormat('%d-%m-%Y');
					switch(d.name){
						case 'http://collaborne.com/schema/1.0/tasks/sensing':
							return `Sensing: ${format(new Date(d.date))}`;
						case 'http://collaborne.com/schema/1.0/tasks/visioning':
							return `Visioning: ${format(new Date(d.date))}`;
						case 'http://collaborne.com/schema/1.0/tasks/prototyping':
							return `Prototyping: ${format(new Date(d.date))}`;
						case 'http://collaborne.com/schema/1.0/tasks/scaling':
							return `Scaling: ${format(new Date(d.date))}`;
						default:
							return '';
					}
				}

				// Add the scatterplot
				svg.selectAll('dot')
					.data(inputData)
					.enter().append('circle')
					.attr('r', 8)
					.attr('cx', function (d) {
						return x(d.date);
					})
					.attr('cy', function (d) {
						return y(d.close);
					})
					.on('mouseover', function(d) {
						svg.append('text')
							.attr('class', 'tooltip')
							.text(buildTooltipText(d))
							.attr('x', x(d.date) + 8)
							.attr('y', y(d.close) + 16);
					})
					.on('mouseout', function(d) {
						d3.selectAll('.tooltip').remove();
					})
					.style('fill', d => {
						switch(d.name){
							case 'http://collaborne.com/schema/1.0/tasks/sensing':
								return 'blue';
							case 'http://collaborne.com/schema/1.0/tasks/visioning':
								return 'red';
							case 'http://collaborne.com/schema/1.0/tasks/prototyping':
								return 'yellow';
							case 'http://collaborne.com/schema/1.0/tasks/scaling':
								return 'green';
							default:
								return 'grey';
						}
					})
					.call(dragbehaviour);

			// Add text with percentage to dots
			svg.selectAll('dot')
				.data(inputData)
				.enter().append('text')
				.attr('x', d => x(d.date) - 16)
				.attr('y', d => y(d.close) - 16)
				.text(d => `${Math.round(d.progress * 100)} %`)
				.style('margin-bottom', '16px');

			// Add the X Axis
			svg.append('g')
				.attr('class', 'x axis')
				.attr('transform', 'translate(0,' + height + ')')
				.call(xAxis);

			// Add the Y Axis
			svg.append('g')
				.attr('class', 'y axis')
				.call(yAxis);
			}
		}
		customElements.define(D3TaskPlanner.is, D3TaskPlanner);
	</script>
</dom-module>
